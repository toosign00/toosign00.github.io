name: "CodeQL Advanced with PR Comments"

on:
  push:
    branches: [ "develop", "main" ]
  pull_request:
    branches: [ "develop", "main" ]
  schedule:
    - cron: '0 0 * * 1'  # ë§¤ì£¼ ì›”ìš”ì¼ í•œêµ­ì‹œê°„ 09:00

jobs:
  analyze:
    name: Analyze (${{ matrix.language }})
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      packages: read
      actions: read
      contents: read
      pull-requests: write

    strategy:
      fail-fast: false
      matrix:
        include:
        - language: javascript-typescript
          build-mode: none

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: ${{ matrix.language }}
        build-mode: ${{ matrix.build-mode }}

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
      with:
        category: "/language:${{matrix.language}}"
        # í•­ìƒ Security íƒ­ì— ì—…ë¡œë“œ (job í†µí•©ìœ¼ë¡œ í•´ê²°)
        upload: true

    # PRì—ë§Œ ìƒì„¸ ì½”ë©˜íŠ¸ ì¶”ê°€
    - name: Add comment to PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const { execSync } = require('child_process');
          
          // í˜„ì¬ ìŠ¤ìº” ê²°ê³¼ ì¡°íšŒ
          let currentAlerts = [];
          let scanSummary = {
            critical: 0,
            high: 0,
            medium: 0,
            low: 0,
            note: 0,
            total: 0
          };
          
          try {
            // GitHub APIë¡œ í˜„ì¬ ì•Œë¦¼ ì¡°íšŒ
            const alerts = await github.rest.codeScanning.listAlertsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });
            
            currentAlerts = alerts.data;
            
            // ì‹¬ê°ë„ë³„ ë¶„ë¥˜
            currentAlerts.forEach(alert => {
              const severity = alert.rule?.severity || 'note';
              if (scanSummary.hasOwnProperty(severity)) {
                scanSummary[severity]++;
              }
              scanSummary.total++;
            });
            
          } catch (error) {
            console.log('API í˜¸ì¶œ ì‹¤íŒ¨, ê¸°ë³¸ ì½”ë©˜íŠ¸ë¡œ ì§„í–‰:', error.message);
          }
          
          // íŒŒì¼ ë³€ê²½ í†µê³„
          let fileStats = {
            added: 0,
            modified: 0,
            deleted: 0,
            total: 0
          };
          
          try {
            const files = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            files.data.forEach(file => {
              fileStats.total++;
              if (file.status === 'added') fileStats.added++;
              else if (file.status === 'modified') fileStats.modified++;
              else if (file.status === 'removed') fileStats.deleted++;
            });
          } catch (error) {
            console.log('íŒŒì¼ í†µê³„ ì¡°íšŒ ì‹¤íŒ¨:', error.message);
          }
          
          // ì½”ë“œ ë³€ê²½ëŸ‰ ê³„ì‚°
          let codeChanges = {
            additions: 0,
            deletions: 0,
            total: 0
          };
          
          try {
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            codeChanges.additions = pr.data.additions || 0;
            codeChanges.deletions = pr.data.deletions || 0;
            codeChanges.total = codeChanges.additions + codeChanges.deletions;
          } catch (error) {
            console.log('ì½”ë“œ ë³€ê²½ëŸ‰ ì¡°íšŒ ì‹¤íŒ¨:', error.message);
          }
          
          // ë³´ì•ˆ ìƒíƒœ ì´ëª¨ì§€ ë° ë©”ì‹œì§€
          const getSecurityStatus = () => {
            if (scanSummary.critical > 0 || scanSummary.high > 0) {
              return { emoji: 'ğŸš¨', status: 'CRITICAL', color: 'ğŸ”´', message: 'ì¦‰ì‹œ ìˆ˜ì •ì´ í•„ìš”í•œ ì‹¬ê°í•œ ë³´ì•ˆ ì´ìŠˆê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.' };
            } else if (scanSummary.medium > 0) {
              return { emoji: 'âš ï¸', status: 'WARNING', color: 'ğŸŸ¡', message: 'ì£¼ì˜ê°€ í•„ìš”í•œ ë³´ì•ˆ ì´ìŠˆê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.' };
            } else if (scanSummary.low > 0 || scanSummary.note > 0) {
              return { emoji: 'ğŸ’¡', status: 'INFO', color: 'ğŸ”µ', message: 'ê²½ë¯¸í•œ ë³´ì•ˆ ê¶Œì¥ì‚¬í•­ì´ ìˆìŠµë‹ˆë‹¤.' };
            } else {
              return { emoji: 'âœ…', status: 'SECURE', color: 'ğŸŸ¢', message: 'ë³´ì•ˆ ê²€ì‚¬ë¥¼ í†µê³¼í–ˆìŠµë‹ˆë‹¤!' };
            }
          };
          
          const securityStatus = getSecurityStatus();
          
          // ìƒìœ„ ì·¨ì•½ì  ëª©ë¡ (ìµœëŒ€ 5ê°œ)
          const getTopVulnerabilities = () => {
            if (currentAlerts.length === 0) return '';
            
            const sortedAlerts = currentAlerts
              .sort((a, b) => {
                const severityOrder = { critical: 4, high: 3, medium: 2, low: 1, note: 0 };
                return (severityOrder[b.rule?.severity] || 0) - (severityOrder[a.rule?.severity] || 0);
              })
              .slice(0, 5);
            
            let table = '| ì‹¬ê°ë„ | ê·œì¹™ | íŒŒì¼ | ì„¤ëª… |\n|--------|------|------|------|\n';
            
            sortedAlerts.forEach(alert => {
              const severity = alert.rule?.severity || 'note';
              const severityEmoji = {
                critical: 'ğŸ”´',
                high: 'ğŸŸ ', 
                medium: 'ğŸŸ¡',
                low: 'ğŸ”µ',
                note: 'â„¹ï¸'
              }[severity] || 'â„¹ï¸';
              
              const ruleName = alert.rule?.name || 'Unknown';
              const fileName = alert.most_recent_instance?.location?.path || 'Unknown';
              const description = (alert.rule?.description || 'No description').substring(0, 60) + '...';
              
              table += `| ${severityEmoji} ${severity.toUpperCase()} | \`${ruleName}\` | \`${fileName}\` | ${description} |\n`;
            });
            
            return table;
          };
          
          // ë³´ì•ˆ ê¶Œì¥ì‚¬í•­
          const getSecurityRecommendations = () => {
            const recommendations = [];
            
            if (scanSummary.critical > 0 || scanSummary.high > 0) {
              recommendations.push('ğŸš¨ **ì¦‰ì‹œ ì¡°ì¹˜**: Critical/High ì´ìŠˆëŠ” ë¨¸ì§€ ì „ í•„ìˆ˜ ìˆ˜ì •');
              recommendations.push('ğŸ”’ **ë³´ì•ˆ ê²€í† **: íŒ€ ë³´ì•ˆ ë‹´ë‹¹ìì™€ ì½”ë“œ ë¦¬ë·° ì§„í–‰');
            }
            
            if (scanSummary.medium > 0) {
              recommendations.push('â° **ê³„íš ìˆ˜ì •**: Medium ì´ìŠˆëŠ” ë‹¤ìŒ ìŠ¤í”„ë¦°íŠ¸ì—ì„œ ìˆ˜ì • ê³„íš');
            }
            
            if (fileStats.total > 50) {
              recommendations.push('ğŸ“‹ **ëŒ€ê·œëª¨ ë³€ê²½**: íŒŒì¼ ë³€ê²½ì´ ë§ì•„ ì¶”ê°€ ë³´ì•ˆ ê²€í†  ê¶Œì¥');
            }
            
            if (codeChanges.total > 1000) {
              recommendations.push('ğŸ” **ì½”ë“œ ê²€ì¦**: ë³€ê²½ëŸ‰ì´ ë§ì•„ ë‹¨ê³„ë³„ í…ŒìŠ¤íŠ¸ ê¶Œì¥');
            }
            
            // JavaScript/TypeScript íŠ¹í™” ê¶Œì¥ì‚¬í•­
            recommendations.push('ğŸ›¡ï¸ **JavaScript ë³´ì•ˆ**: XSS, í”„ë¡œí† íƒ€ì… ì˜¤ì—¼ ë“± ì›¹ ë³´ì•ˆ ì·¨ì•½ì  ì ê²€');
            recommendations.push('ğŸ” **ì˜ì¡´ì„± ê²€ì‚¬**: npm auditìœ¼ë¡œ íŒ¨í‚¤ì§€ ì·¨ì•½ì  í™•ì¸');
            
            if (recommendations.length === 0) {
              recommendations.push('âœ¨ **ì¢‹ì€ ì½”ë“œ**: ë³´ì•ˆ ëª¨ë²”ì‚¬ë¡€ë¥¼ ì˜ ë”°ë¥´ê³  ìˆìŠµë‹ˆë‹¤!');
            }
            
            return recommendations.map(rec => `- ${rec}`).join('\n');
          };
          
          // ì„±ëŠ¥ ë° ë³´ì•ˆ ë©”íŠ¸ë¦­
          const getMetrics = () => {
            const riskScore = Math.min(100, 
              (scanSummary.critical * 25) + 
              (scanSummary.high * 15) + 
              (scanSummary.medium * 5) + 
              (scanSummary.low * 1)
            );
            
            const changeRisk = codeChanges.total > 500 ? 'High' : 
                             codeChanges.total > 200 ? 'Medium' : 'Low';
            
            return {
              riskScore,
              changeRisk,
              securityCoverage: fileStats.total > 0 ? '100%' : 'N/A'
            };
          };
          
          const metrics = getMetrics();
          
          // ìµœì¢… ì½”ë©˜íŠ¸ ìƒì„±
          const comment = `# ${securityStatus.emoji} CodeQL ê³ ê¸‰ ë³´ì•ˆ ìŠ¤ìº” ê²°ê³¼
          
          ## ğŸ“Š ë³´ì•ˆ ìƒíƒœ: ${securityStatus.color} **${securityStatus.status}**
          ${securityStatus.message}
          
          ### ğŸ¯ ìŠ¤ìº” ìš”ì•½
          | í•­ëª© | ê°’ | ìƒì„¸ |
          |------|----|----|
          | **ì´ ì´ìŠˆ** | **${scanSummary.total}ê°œ** | ${scanSummary.critical}ğŸ”´ ${scanSummary.high}ğŸŸ  ${scanSummary.medium}ğŸŸ¡ ${scanSummary.low}ğŸ”µ ${scanSummary.note}â„¹ï¸ |
          | **ìœ„í—˜ ì ìˆ˜** | **${metrics.riskScore}/100** | ${metrics.riskScore > 50 ? 'ë†’ìŒ' : metrics.riskScore > 20 ? 'ë³´í†µ' : 'ë‚®ìŒ'} |
          | **ë³€ê²½ ìœ„í—˜ë„** | **${metrics.changeRisk}** | ${codeChanges.total}ì¤„ ë³€ê²½ (${codeChanges.additions}â• ${codeChanges.deletions}â–) |
          | **ë³´ì•ˆ ì»¤ë²„ë¦¬ì§€** | **${metrics.securityCoverage}** | ${fileStats.total}ê°œ íŒŒì¼ ìŠ¤ìº” |
          
          ### ğŸ“ ë³€ê²½ íŒŒì¼ ë¶„ì„
          - ğŸ“ **ìˆ˜ì •ëœ íŒŒì¼**: ${fileStats.modified}ê°œ
          - â• **ì¶”ê°€ëœ íŒŒì¼**: ${fileStats.added}ê°œ  
          - â– **ì‚­ì œëœ íŒŒì¼**: ${fileStats.deleted}ê°œ
          - ğŸ“ **ì´ ë³€ê²½ëŸ‰**: ${codeChanges.total}ì¤„ (ì¶”ê°€ ${codeChanges.additions}, ì‚­ì œ ${codeChanges.deletions})
          
          ${currentAlerts.length > 0 ? `### ğŸ” ì£¼ìš” ë³´ì•ˆ ì´ìŠˆ (ìƒìœ„ ${Math.min(5, currentAlerts.length)}ê°œ)
          ${getTopVulnerabilities()}` : ''}
          
          ### ğŸ›¡ï¸ ë³´ì•ˆ ê¶Œì¥ì‚¬í•­
          ${getSecurityRecommendations()}
          
          ### ğŸ”— ìƒì„¸ ì •ë³´ ë° ë§í¬
          - ğŸ“‹ **ì „ì²´ ë³´ì•ˆ ìŠ¤ìº”**: [Security íƒ­](https://github.com/${context.repo.owner}/${context.repo.repo}/security/code-scanning)
          - ğŸ“ˆ **ë³´ì•ˆ íŠ¸ë Œë“œ**: [Security Insights](https://github.com/${context.repo.owner}/${context.repo.repo}/pulse/security)
          - ğŸ”§ **ìˆ˜ì • ê°€ì´ë“œ**: ê° ì´ìŠˆ í´ë¦­ ì‹œ ìƒì„¸ ì„¤ëª… ë° í•´ê²° ë°©ë²• ì œê³µ
          - ğŸ“š **ë³´ì•ˆ ë¬¸ì„œ**: [CodeQL ë³´ì•ˆ ê°€ì´ë“œ](https://docs.github.com/en/code-security/code-scanning)
          
          ### âš¡ ë¹ ë¥¸ ì•¡ì…˜
          \`\`\`bash
          # ë¡œì»¬ì—ì„œ ë³´ì•ˆ ê²€ì‚¬ ì‹¤í–‰
          pnpm audit                    # ì˜ì¡´ì„± ì·¨ì•½ì  ê²€ì‚¬
          pnpm audit --fix              # ìë™ ìˆ˜ì • ê°€ëŠ¥í•œ ì·¨ì•½ì  í•´ê²°
          
          # ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
          pnpm check                  # ESLint, Formatting, Type Check ì‹¤í–‰
          \`\`\`
          
          ---
          
          <details>
          <summary>ğŸ¤– <strong>ìŠ¤ìº” ìƒì„¸ ì •ë³´</strong></summary>
          
          - **ğŸ•’ ìŠ¤ìº” ì‹œê°„**: ${new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' })}
          - **ğŸ“ ë¶„ì„ ì–¸ì–´**: JavaScript/TypeScript
          - **ğŸ” ìŠ¤ìº” ë²”ìœ„**: ì „ì²´ ì†ŒìŠ¤ì½”ë“œ (${fileStats.total}ê°œ íŒŒì¼)
          - **âš¡ ì‹¤í–‰ í™˜ê²½**: GitHub Actions (Ubuntu Latest)
          - **ğŸ“Š ìŠ¤ìº” ID**: \`${context.runId}\`
          - **ğŸŒ¿ ë¸Œëœì¹˜**: \`${context.ref}\`
          - **ğŸ’¾ ì»¤ë°‹**: \`${context.sha.substring(0, 7)}\`
          
          **CodeQL ë²„ì „**: ìµœì‹  ì•ˆì • ë²„ì „  
          **ë³´ì•ˆ ì¿¼ë¦¬**: í‘œì¤€ + í™•ì¥ ë³´ì•ˆ ì¿¼ë¦¬íŒ©  
          **ë¶„ì„ ëª¨ë“œ**: ê³ ê¸‰ ë¶„ì„ (Deep Scan)
          
          </details>
          
          ---
          *ğŸ”’ CodeQL Advanced Security Scan | ìë™ ìƒì„±ë¨ ${new Date().toISOString()}*`;
          
          await github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
