name: "CodeQL Advanced with PR Comments"

on:
  push:
    branches: [ "develop", "main" ]
  pull_request:
    branches: [ "develop", "main" ]
  schedule:
    - cron: '0 0 * * 1'  # ë§¤ì£¼ ì›”ìš”ì¼ í•œêµ­ì‹œê°„ 09:00

jobs:
  analyze:
    name: Analyze (${{ matrix.language }})
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      packages: read
      actions: read
      contents: read
      pull-requests: write

    strategy:
      fail-fast: false
      matrix:
        include:
        - language: javascript-typescript
          build-mode: none

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: ${{ matrix.language }}
        build-mode: ${{ matrix.build-mode }}

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
      with:
        category: "/language:${{matrix.language}}"
        # í•­ìƒ Security íƒ­ì— ì—…ë¡œë“œ (job í†µí•©ìœ¼ë¡œ í•´ê²°)
        upload: true

    # PRì—ë§Œ ìƒì„¸ ì½”ë©˜íŠ¸ ì¶”ê°€
    - name: Add comment to PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const comment = `## ğŸ›¡ï¸ CodeQL ë³´ì•ˆ ìŠ¤ìº” ê²°ê³¼

          âœ… **ë³´ì•ˆ ìŠ¤ìº”ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.**
          
          ğŸ“Š **ê²°ê³¼ í™•ì¸**: [Security íƒ­](https://github.com/${{ github.repository }}/security/code-scanning)ì—ì„œ ìƒì„¸ ë‚´ìš©ì„ í™•ì¸í•˜ì„¸ìš”.
          
          ### ğŸ“‹ ìŠ¤ìº” ì •ë³´
          - ğŸ•’ **ìŠ¤ìº” ì‹œê°„**: ${new Date().toLocaleString('ko-KR')}
          - ğŸ“ **ë¶„ì„ ì–¸ì–´**: JavaScript/TypeScript
          - ğŸ” **ìŠ¤ìº” ë²”ìœ„**: ì „ì²´ ì†ŒìŠ¤ì½”ë“œ
          - âš¡ **ì‹¤í–‰ í™˜ê²½**: GitHub Actions
          
          ### ğŸ”— ì¶”ê°€ ì •ë³´
          - ğŸ›¡ï¸ **ë³´ì•ˆ ì´ìŠˆ**: Security íƒ­ì—ì„œ í™•ì¸
          - ğŸ“ˆ **ë³´ì•ˆ íŠ¸ë Œë“œ**: Insights > Securityì—ì„œ í™•ì¸
          - ğŸ”§ **ìˆ˜ì • ê°€ì´ë“œ**: ê° ì´ìŠˆë³„ ìƒì„¸ ì„¤ëª… ì œê³µ
          
          > ğŸ’¡ **ì°¸ê³ **: ë³´ì•ˆ ì´ìŠˆê°€ ë°œê²¬ëœ ê²½ìš° Security íƒ­ì—ì„œ ìš°ì„ ìˆœìœ„ì™€ ìˆ˜ì • ë°©ë²•ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          
          ---
          _ğŸ¤– CodeQL Advanced Scan | ${new Date().toISOString()}_`;

          await github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
