name: "CodeQL Advanced with Smart PR Comments"

on:
  push:
    branches: [ "develop", "main" ]
  pull_request:
    branches: [ "develop", "main" ]
  schedule:
    - cron: '0 0 * * 1'  # ë§¤ì£¼ ì›”ìš”ì¼ í•œêµ­ì‹œê°„ 09:00

jobs:
  analyze:
    name: Analyze (${{ matrix.language }})
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      packages: read
      actions: read
      contents: read
      pull-requests: write

    strategy:
      fail-fast: false
      matrix:
        include:
        - language: javascript-typescript
          build-mode: none

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: ${{ matrix.language }}
        build-mode: ${{ matrix.build-mode }}

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
      with:
        category: "/language:${{matrix.language}}"
        upload: true

    # PRì— ì½”ë©˜íŠ¸ ì¶”ê°€
    - name: Add comment to PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
          const createApiCall = async (apiCall, fallback = null) => {
            try {
              return await apiCall();
            } catch (error) {
              console.log(`API í˜¸ì¶œ ì‹¤íŒ¨: ${error.message}`);
              return fallback;
            }
          };

          // ë³‘ë ¬ë¡œ ë°ì´í„° ìˆ˜ì§‘
          const [alertsResult, filesResult, prResult] = await Promise.allSettled([
            createApiCall(() => github.rest.codeScanning.listAlertsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            })),
            createApiCall(() => github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            })),
            createApiCall(() => github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            }))
          ]);

          // ë°ì´í„° ì¶”ì¶œ ë° fallback ì²˜ë¦¬
          const alerts = alertsResult.status === 'fulfilled' ? alertsResult.value?.data || [] : [];
          const files = filesResult.status === 'fulfilled' ? filesResult.value?.data || [] : [];
          const prData = prResult.status === 'fulfilled' ? prResult.value?.data : null;

          // ìŠ¤ìº” ìš”ì•½ ê³„ì‚°
          const scanSummary = alerts.reduce((acc, alert) => {
            const severity = alert.rule?.severity || 'note';
            acc[severity] = (acc[severity] || 0) + 1;
            acc.total++;
            return acc;
          }, { critical: 0, high: 0, medium: 0, low: 0, note: 0, total: 0 });

          // íŒŒì¼ í†µê³„ ê³„ì‚°
          const fileStats = files.reduce((acc, file) => {
            acc.total++;
            if (file.status === 'added') acc.added++;
            else if (file.status === 'modified') acc.modified++;
            else if (file.status === 'removed') acc.deleted++;
            return acc;
          }, { added: 0, modified: 0, deleted: 0, total: 0 });

          // ì½”ë“œ ë³€ê²½ëŸ‰
          const codeChanges = {
            additions: prData?.additions || 0,
            deletions: prData?.deletions || 0,
            total: (prData?.additions || 0) + (prData?.deletions || 0)
          };

          // ì½”ë©˜íŠ¸ ë ˆë²¨ ê²°ì •
          const getCommentLevel = () => {
            if (scanSummary.critical > 0 || scanSummary.high > 0) return 'CRITICAL';
            if (codeChanges.total > 1000 || fileStats.total > 50) return 'DETAILED';
            if (scanSummary.total > 0) return 'SUMMARY';
            return 'MINIMAL';
          };

          const commentLevel = getCommentLevel();

          // ë³´ì•ˆ ìƒíƒœ ê²°ì •
          const getSecurityStatus = () => {
            if (scanSummary.critical > 0 || scanSummary.high > 0) {
              return { emoji: 'ğŸš¨', status: 'CRITICAL', color: 'ğŸ”´', 
                      message: 'ì¦‰ì‹œ ìˆ˜ì •ì´ í•„ìš”í•œ ì‹¬ê°í•œ ë³´ì•ˆ ì´ìŠˆê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.' };
            } else if (scanSummary.medium > 0) {
              return { emoji: 'âš ï¸', status: 'WARNING', color: 'ğŸŸ¡', 
                      message: 'ì£¼ì˜ê°€ í•„ìš”í•œ ë³´ì•ˆ ì´ìŠˆê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.' };
            } else if (scanSummary.low > 0 || scanSummary.note > 0) {
              return { emoji: 'ğŸ’¡', status: 'INFO', color: 'ğŸ”µ', 
                      message: 'ê²½ë¯¸í•œ ë³´ì•ˆ ê¶Œì¥ì‚¬í•­ì´ ìˆìŠµë‹ˆë‹¤.' };
            } else {
              return { emoji: 'âœ…', status: 'SECURE', color: 'ğŸŸ¢', 
                      message: 'ë³´ì•ˆ ê²€ì‚¬ë¥¼ í†µê³¼í–ˆìŠµë‹ˆë‹¤!' };
            }
          };

          const securityStatus = getSecurityStatus();

          // ì•¡ì…˜ ë²„íŠ¼ ìƒì„±
          const getActionButtons = () => {
            const actions = [];
            
            if (scanSummary.critical > 0 || scanSummary.high > 0) {
              actions.push(`ğŸš¨ [Critical ì´ìŠˆ í™•ì¸](https://github.com/${context.repo.owner}/${context.repo.repo}/security/code-scanning?query=is%3Aopen+severity%3Acritical%2Chigh)`);
            }
            
            if (scanSummary.medium > 0) {
              actions.push(`âš ï¸ [Medium ì´ìŠˆ ê²€í† ](https://github.com/${context.repo.owner}/${context.repo.repo}/security/code-scanning?query=is%3Aopen+severity%3Amedium)`);
            }
            
            if (scanSummary.total > 0) {
              actions.push(`ğŸ“Š [ì „ì²´ ë³´ì•ˆ ëŒ€ì‹œë³´ë“œ](https://github.com/${context.repo.owner}/${context.repo.repo}/security)`);
            }
            
            // React/JavaScript íŠ¹í™” ì•¡ì…˜
            actions.push(`ğŸ” \`npm audit\` | ğŸ› ï¸ \`npm audit --fix\` | âš¡ \`pnpm check\``);
            
            return actions.length > 0 ? actions.join(' | ') : '';
          };

          // ìœ„í—˜ ì ìˆ˜ ê³„ì‚°
          const calculateRiskScore = () => {
            return Math.min(100, 
              (scanSummary.critical * 25) + 
              (scanSummary.high * 15) + 
              (scanSummary.medium * 5) + 
              (scanSummary.low * 1)
            );
          };

          // ë ˆë²¨ë³„ ì½”ë©˜íŠ¸ ìƒì„±
          const generateComment = () => {
            const riskScore = calculateRiskScore();
            
            // ê³µí†µ í—¤ë”
            let comment = `# ${securityStatus.emoji} CodeQL ë³´ì•ˆ ìŠ¤ìº” ê²°ê³¼\n\n`;
            comment += `## ${securityStatus.color} **${securityStatus.status}** | ìœ„í—˜ë„: **${riskScore}/100**\n`;
            comment += `${securityStatus.message}\n\n`;

            if (commentLevel === 'MINIMAL') {
              // ìµœì†Œ ì •ë³´ë§Œ í‘œì‹œ
              comment += `âœ¨ **ë³€ê²½ ìš”ì•½**: ${fileStats.total}ê°œ íŒŒì¼, ${codeChanges.total}ì¤„ ë³€ê²½\n`;
              comment += `ğŸ›¡ï¸ **ë³´ì•ˆ**: ì´ìŠˆ ì—†ìŒ, ì•ˆì „í•œ ë³€ê²½ì…ë‹ˆë‹¤!\n\n`;
              
            } else if (commentLevel === 'SUMMARY') {
              // ìš”ì•½ ì •ë³´
              comment += `### ğŸ“‹ ìš”ì•½\n`;
              comment += `| í•­ëª© | ê°’ |\n|------|----|\n`;
              comment += `| ë³´ì•ˆ ì´ìŠˆ | **${scanSummary.total}ê°œ** (${scanSummary.medium}ğŸŸ¡ ${scanSummary.low}ğŸ”µ ${scanSummary.note}â„¹ï¸) |\n`;
              comment += `| ë³€ê²½ íŒŒì¼ | **${fileStats.total}ê°œ** (${fileStats.added}â• ${fileStats.modified}ğŸ“ ${fileStats.deleted}â–) |\n`;
              comment += `| ì½”ë“œ ë³€ê²½ | **${codeChanges.total}ì¤„** (${codeChanges.additions}â• ${codeChanges.deletions}â–) |\n\n`;
              
            } else {
              // ìƒì„¸ ì •ë³´ (DETAILED ë˜ëŠ” CRITICAL)
              comment += `### ğŸ“Š ìƒì„¸ ë¶„ì„\n`;
              comment += `| í•­ëª© | ê°’ | ìƒì„¸ |\n|------|----|----|`;
              comment += `| **ë³´ì•ˆ ì´ìŠˆ** | **${scanSummary.total}ê°œ** | ${scanSummary.critical}ğŸ”´ ${scanSummary.high}ğŸŸ  ${scanSummary.medium}ğŸŸ¡ ${scanSummary.low}ğŸ”µ ${scanSummary.note}â„¹ï¸ |\n`;
              comment += `| **ìœ„í—˜ ì ìˆ˜** | **${riskScore}/100** | ${riskScore > 50 ? 'ë†’ìŒ ğŸš¨' : riskScore > 20 ? 'ë³´í†µ âš ï¸' : 'ë‚®ìŒ âœ…'} |\n`;
              comment += `| **ë³€ê²½ ê·œëª¨** | **${codeChanges.total}ì¤„** | ${fileStats.total}ê°œ íŒŒì¼ (${codeChanges.additions}â• ${codeChanges.deletions}â–) |\n\n`;

              // Critical/High ì´ìŠˆê°€ ìˆì„ ë•Œë§Œ ìƒìœ„ ì·¨ì•½ì  í‘œì‹œ
              if (scanSummary.critical > 0 || scanSummary.high > 0) {
                const criticalAlerts = alerts
                  .filter(alert => ['critical', 'high'].includes(alert.rule?.severity))
                  .slice(0, 3);
                
                if (criticalAlerts.length > 0) {
                  comment += `### ğŸš¨ ê¸´ê¸‰ ìˆ˜ì • í•„ìš”\n`;
                  comment += `| ì‹¬ê°ë„ | ê·œì¹™ | íŒŒì¼ |\n|--------|------|------|\n`;
                  
                  criticalAlerts.forEach(alert => {
                    const severity = alert.rule?.severity === 'critical' ? 'ğŸ”´ CRITICAL' : 'ğŸŸ  HIGH';
                    const ruleName = alert.rule?.name || 'Unknown';
                    const fileName = alert.most_recent_instance?.location?.path || 'Unknown';
                    comment += `| ${severity} | \`${ruleName}\` | \`${fileName}\` |\n`;
                  });
                  comment += `\n`;
                }
              }
            }

            // ì•¡ì…˜ ë²„íŠ¼ì€ í•­ìƒ í‘œì‹œ (ì´ìŠˆê°€ ìˆì„ ë•Œë§Œ)
            if (scanSummary.total > 0) {
              comment += `### âš¡ ë¹ ë¥¸ ì•¡ì…˜\n${getActionButtons()}\n\n`;
            }

            // React/JS íŠ¹í™” ê¶Œì¥ì‚¬í•­
            if (scanSummary.total > 0) {
              comment += `### ğŸ”’ React/JavaScript ë³´ì•ˆ ì²´í¬ë¦¬ìŠ¤íŠ¸\n`;
              comment += `- [ ] XSS ë°©ì§€: dangerouslySetInnerHTML ì‚¬ìš© ê²€í† \n`;
              comment += `- [ ] ì˜ì¡´ì„± ê²€ì‚¬: \`npm audit\` ì‹¤í–‰\n`;
              comment += `- [ ] í™˜ê²½ë³€ìˆ˜: ë¯¼ê°ì •ë³´ í•˜ë“œì½”ë”© í™•ì¸\n`;
              comment += `- [ ] API ë³´ì•ˆ: ì¸ì¦/ì¸ê°€ ë¡œì§ ê²€ì¦\n\n`;
            }

            // í‘¸í„°
            comment += `---\n`;
            comment += `<details><summary>ğŸ” ìŠ¤ìº” ìƒì„¸ ì •ë³´</summary>\n\n`;
            comment += `- **ìŠ¤ìº” ì‹œê°„**: ${new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' })}\n`;
            comment += `- **ì»¤ë°‹**: \`${context.sha.substring(0, 7)}\`\n`;
            comment += `- **ë¸Œëœì¹˜**: \`${context.ref.replace('refs/heads/', '')}\`\n`;
            comment += `- **ì‹¤í–‰ ID**: \`${context.runId}\`\n\n`;
            comment += `</details>\n\n`;
            comment += `*ğŸ¤– ìë™ ìƒì„±ë¨ | ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${new Date().toISOString()}*`;

            return comment;
          };

          const finalComment = generateComment();

          // ê¸°ì¡´ ë´‡ ì½”ë©˜íŠ¸ ì°¾ê¸°
          const existingComment = await createApiCall(async () => {
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            
            return comments.data.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('CodeQL ë³´ì•ˆ ìŠ¤ìº” ê²°ê³¼')
            );
          });

          // ì½”ë©˜íŠ¸ ì—…ë°ì´íŠ¸ ë˜ëŠ” ìƒì„±
          try {
            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: finalComment
              });
              console.log('ê¸°ì¡´ ì½”ë©˜íŠ¸ë¥¼ ì—…ë°ì´íŠ¸í–ˆìŠµë‹ˆë‹¤.');
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: finalComment
              });
              console.log('ìƒˆ ì½”ë©˜íŠ¸ë¥¼ ìƒì„±í–ˆìŠµë‹ˆë‹¤.');
            }
          } catch (error) {
            console.log('ì½”ë©˜íŠ¸ ìƒì„±/ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error.message);
          }
